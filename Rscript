# Cleavage site specificity analysis

library(seqinr)
library(tidyverse)
library(pheatmap)

# assuming your data frame is named 'key_df' and the key column is named 'key_column'
key_df <- read_tsv("/peptide.tsv") %>%    # import your peptide.tsv file from FragPipe
    clean_names() %>%
    rename(name = protein)

# read the fasta file and store sequences
fasta_sequences <- read.fasta("/protein.fas",    # import your protein.fas file from FragPipe
    seqtype = "AA",
    as.string = TRUE
)

fasta_names <- sapply(fasta_sequences, attr, "name")

# here is a function to match names and extract sequences
matched_sequences <- lapply(key_df$name, function(name) {
    idx <- match(name, fasta_names)
    if (!is.na(idx)) {
        return(as.character(fasta_sequences[[idx]]))
    } else {
        return("Name not found in fasta file")
    }
})

# add matched sequences to the data frame
key_df$protein_sequence <- matched_sequences

# match peptide sequence, extract previous 4 amino acids, and add to a new column called previous_4_aa
key_df <- key_df %>%
    mutate(previous_4_aa = sapply(1:nrow(.), function(row_idx) {
        peptide <- key_df$peptide[row_idx]
        protein <- key_df$protein_sequence[row_idx]
        match_idx <- regexpr(peptide, protein)
        if (match_idx > 0) {
            start_idx <- max(match_idx - 4, 1)
            previous_aa <- substr(protein, start_idx, match_idx - 1)
            return(previous_aa)
        } else {
            return("Peptide not found in protein")
        }
    }))

# mutate a new column with the previous 4 amino acids plus the original peptide
key_df <- key_df %>%
    mutate(fingerprint_protease = paste(previous_4_aa, peptide, sep = "")) %>%
    filter(
        !grepl("Peptide not found in protein", fingerprint_protease),
        previous_4_aa != "M"
    )

# remove the rows where the previous 4 amino acids are less than 4
key_df <- key_df %>%
    filter(nchar(previous_4_aa) == 4)

# keep the first 8 amino acids of the fingerprint
key_df$fingerprint_protease <- substr(key_df$fingerprint_protease, 1, 8)

# create a list of sequences
fingerprint_list <- strsplit(key_df$fingerprint_protease, "")

mat_aa <- matrix(unlist(fingerprint_list), ncol = 8, byrow = TRUE)

# remove the rows containing "B" or any other unwanted amino acid in the matrix
# mat_aa <- mat_aa[!apply(mat_aa, 1, function(x) any(x == "B")), ]

# if for some weird reason your matrix does not contain even number of columns, try the following:
# mat_aa <- do.call(rbind, mat_aa)

# calculate the frequency of each amino acid in each column
mat_aa_freq <- apply(mat_aa, 2, function(x) table(x) / length(x)) * 100
colnames(mat_aa_freq) <- c("P4", "P3", "P2", "P1", "P1'", "P2'", "P3'", "P4'")
# if you have used do.call function, then you need the rownames instead of colnames
# rownames(mat_aa_freq) <- c("P4", "P3", "P2", "P1", "P1'", "P2'", "P3'", "P4'")

# plot the heatmap
mat_aa_freq %>%
    pheatmap(
        cluster_rows = FALSE,
        cluster_cols = FALSE,
        fontsize = 20,
        show_rownames = TRUE,
        show_colnames = TRUE,
        color = colorRampPalette(c("grey95", "#A73030FF"))(20),
        main = "Cleavage Site specificity",
        gaps_col = 4
    )
